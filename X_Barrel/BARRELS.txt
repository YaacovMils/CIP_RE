(*!
@purpose
This program (`BARRELS.txt`) implements a specialized, sequential logic for managing the Cleaning-In-Place (CIP) process for portable barrels. It acts as a high-level state machine that uses the underlying functionality of the main CIP Line C to execute a complete, multi-stage cleaning cycle.

The program sequences through its own stages (`BR_ST1`, `BR_ST2`, `BR_ST3`), but instead of controlling pumps and valves directly, it sends commands to the CIP C program (`CIPCCDL`) and waits for feedback that the commanded action is complete (via the `C_STAT` word). This allows it to orchestrate a complex cleaning sequence (pre-rinse, wash, final rinse) by chaining together simpler operations from the main CIP skid.

@inputs
- `BR_WORK` (%M00184): The master start flag for the entire barrel CIP sequence.
- `C_STAT` (%R09049): The status word from the CIP C process. This program specifically monitors bit 7 (`AND 64`), which indicates that the current CIP C operation has finished.
- `FQCCQTY` (%R09015): The totalized volume of fluid delivered from CIP Line C, used to determine if the barrel is full.
- `CIPCVOL` (%R00597): The target fill volume for the barrel.
- `LSH3072`, `LSL3073`: High and low-level switches for a temporary return tank.
- `BR2USES` (%M00189): A flag to select the cleaning agent for stage 2 (TRUE for soda, FALSE for acid).
- `STOPALL`, `ENDALL`: Global stop/end commands.

@outputs
- `CIPCCDL` (%R00200): A local command register used to send stage commands (1=Start S1, 2=Start S2 Soda, 3=Start S2 Acid, 4=Start S3, 7=End) to the CIP C program.
- `BR_ST1`, `BR_ST2`, `BR_ST3`: Internal state flags for the barrel cleaning sequence (Stage 1, 2, 3).
- `BR_END` (%M00188): A flag indicating the entire barrel CIP sequence is complete.
- `XVM038`, `XVM039`: Commands to open valves for routing fluid to/from the temporary tank.
- `P4072`: Command to run the barrel return pump.
- `En_CIP_SEQ`: A flag to notify another process that the sequence has finished.

@notes
- This code is for a GE/Emerson RX3i PLC and is written in Structured Text (ST).
- This program is a great example of hierarchical control, where a master sequencing program (this one) controls a subordinate process (CIP Line C) to achieve a larger goal.
- The logic to transition between stages is entirely dependent on waiting for the "command complete" bit from `C_STAT`, highlighting the tight integration between this program and the `C_CIP` logic.
*)
VAR_GLOBAL
	#ALW_OFF AT %S00008 : BOOL; (* Always OFF *)
	#ALW_ON AT %S00007 : BOOL; (* Always ON *)
	BR2USES AT %M00189 : BOOL; (* Barrel CIP uses soda on stage 2. *)
	BR_END AT %M00188 : BOOL; (* Barrel end CIP *)
	BR_ST1 AT %M00185 : BOOL; (* Barrel stage 1 *)
	BR_ST2 AT %M00186 : BOOL; (* Barrel stage 2 *)
	BR_ST3 AT %M00187 : BOOL; (* Barrel stage 3 *)
	BR_WORK AT %M00184 : BOOL; (* Barrel CIP in process *)
	C_STAT AT %R09049 : WORD; (* CIP C Status *)
	C_STOP AT %M00155 : BOOL; (* CIP C stopped *)
	CIPCCDL AT %R00200 : INT; (* CIP C command (local-no genius) *)
	CIPCTMR AT %R00201 : ARRAY [0..3] OF WORD; (* CIP C End of stage timer *)
	CIPCVOL AT %R00597 : INT; (* Volume of recator of CIP C *)
	En_CIP_SEQ AT %M01109 : BOOL; (* *)
	ENDALL AT %M00105 : BOOL; (* End all processes *)
	FQCCQTY AT %R09015 : INT; (* FQC C quantity (+genius send) *)
	LSH3072 AT %I00072 : BOOL; (* TEMP. TANK HIGH LEVEL *)
	LSL3073 AT %I00073 : BOOL; (* TEMP. TANK LOW LEVEL *)
	M00061 AT %M00061 : BOOL; (* *)
	M00062 AT %M00062 : BOOL; (* *)
	M00063 AT %M00063 : BOOL; (* *)
	M00280 AT %M00280 : BOOL; (* *)
	M00299 AT %M00299 : BOOL; (* *)
	P4072 AT %M00072 : BOOL; (* Barrel Returen Pump To CIP_C *)
	R00455 AT %R00455 : INT; (* *)
	R09066 AT %R09066 : ARRAY [0..3] OF WORD; (* *)
	STOPALL AT %M00104 : BOOL; (* Stop all processes *)
	XVM038 AT %M00038 : BOOL; (* FROM CIP C TANK TO TEMP. TANK T *)
	XVM039 AT %M00039 : BOOL; (* FROM TEMP. TANK TO CIPS "C" TO *)
	_Bit AT %T00002 : BOOL; (* temporary bit *)
END_VAR

VAR
	TON_CIPCTMR : TON;
	TON_R09066 : TON;
END_VAR

(* Rung 1: COMMENT0 *)

(* Rung 2: Checks if the barrel is full by comparing the delivered volume from CIP C (`FQCCQTY`) to the setpoint (`R00455`). This `FULL` flag is a key interlock for the filling and flushing logic. *)
FULL := BR_WORK AND (BR_ST1 OR BR_ST2 OR BR_ST3) AND (FQCCQTY >= R00455)) ;

(* Rung 3 *)

(* Rung 4: Sets a default fill volume of 500 if no value is provided from the HMI. This logic is currently disabled. *)
IF #ALW_OFF AND (CIPCVOL = 0) THEN
	R00455 := 500;
END_IF;

(* Rung 5: Sets the target fill volume from the HMI. This logic is currently disabled. *)
IF #ALW_OFF AND (CIPCVOL > 300) THEN
	R00455 := CIPCVOL;
END_IF;

(* Rung 6: COMMENT1 *)

(* Rung 7: Determines if the CIP C line is actively washing by checking bit 8 of the `C_STAT` word. This bit is set when a CIP C alarm is NOT present. *)
WASH := BR_WORK AND NOT STOPALL AND NOT ENDALL AND NOT BR_END AND ((C_STAT AND 128) <> 0);

(* Rung 8: Determines when to flush the barrel. This occurs when the barrel is full or when the CIP C line is washing during stages 2 or 3. *)
FLUSH := (WASH AND (BR_ST3 OR BR_ST2))
		  OR (FULL AND (BR_ST1 BR_ST2 OR BR_ST3))
		  AND NOT C_STOP AND NOT STOPALL AND NOT ENDALL AND NOT BR_END;

(* Rung 9: Determines when to fill the barrel. This occurs when the barrel is not full and the current stage is active. *)
FILL := NOT FULL AND ((BR_ST1 OR NOT WASH AND BR_ST2) OR BR_ST3)
		AND NOT STOPALL AND NOT ENDALL AND NOT BR_END;

(* Rung 10: COMMENT2 *)

(* Rung 11: Checks for the "CIP Ended" signal from the CIP C controller by checking bit 7 of the `C_STAT` word. This signal is used to trigger the next stage in the barrel cleaning sequence. *)
CIP_END := BR_WORK AND ((C_STAT AND 64) <> 0);

(* Rung 12: A 40-second timer that determines the end of a stage. The timer starts when the barrel is being flushed and the CIP C line is not washing. *)
TON_CIPCTMR(IN := (NOT WASH AND FLUSH AND NOT C_STOP (AND NOT M00280 OR NOT LSH3072)) AND #ALW_ON,
			PT := T#40S);
END_STG := TON_CIPCTMR.Q;

(* Rung 13: COMMENT3 *)

(* Rung 14: This logic for `XVM038` (valve to temporary tank) appears to be incomplete as it only reads the state of the valve and does not drive it. *)
_Bit := NOT FILL AND NOT C_STOP AND NOT STOPALL AND NOT ENDALL AND NOT BR_END AND XVM038;

(* Rung 15: A 30-second timer that is activated when the barrel is full and the temporary tank is full. The output of this timer is used in the logic for the temporary tank return pump. *)
TON_R09066(IN := #ALW_ON AND FULL AND LSH3072,
		   PT := T#30S);
M00280 := NOT TON_R09066.Q;

(* Rung 16: Controls the return pump (`P4072`) and valve (`XVM039`) for the temporary tank. The pump is activated when the valve is open and the tank is not empty. *)
XVM039 := #ALW_ON AND NOT BR_END AND (M00280 OR(XVM039 AND P4072));
P4072 := XVM039 AND LSL3073;

(* Rung 17: COMMENT4 *)

(* Rung 18: Sends the "End" command (7) to the CIP C controller if the current stage timer has elapsed (`END_STG`) but the CIP C controller has not yet confirmed completion (`NOT CIP_END`). *)
IF BR_WORK AND END_STG AND NOT CIP_END THEN
	CIPCCDL := 7;
END_IF;

(* Rung 19: Not used. *)

(* Rung 20: Sets the `BR_END` (Barrel End) flag and notifies other processes (`En_CIP_SEQ`) when the final stage (Stage 3) is complete. It also resets the master `BR_WORK` flag to terminate the sequence. *)
IF CIP_END AND BR_WORK AND BR_ST3 THEN
	BR_END := TRUE;
	En_CIP_SEQ := TRUE;
END_IF;
IF CIP_END AND BR_WORK AND BR_ST3 AND NOT M00299 THEN
	BR_WORK := FALSE;
END_IF;

(* Rung 21: When Stage 2 is complete (`CIP_END` and `BR_ST2`), this rung commands CIP C to start Stage 3 (command 4) and transitions the internal state machine from Stage 2 to Stage 3. *)
IF CIP_END AND BR_WORK AND BR_ST2 THEN
	CIPCCDL := 4;
	BR_ST3 := TRUE;
	BR_ST2 := FALSE;
END_IF;

(* Rung 22: When Stage 1 is complete and soda is selected (`BR2USES`), this rung commands CIP C to start the soda wash (command 2) and transitions the state machine from Stage 1 to Stage 2. *)
IF CIP_END AND BR_WORK AND BR_ST1 AND BR2USES THEN
	CIPCCDL := 2;
	BR_ST2 := TRUE;
	BR_ST1 := FALSE;
END_IF;

(* Rung 23: When Stage 1 is complete and acid is selected (`NOT BR2USES`), this rung commands CIP C to start the acid wash (command 3) and transitions the state machine from Stage 1 to Stage 2. *)
IF CIP_END AND BR_WORK AND BR_ST1 AND NOT BR2USES THEN
	CIPCCDL := 3;
	BR_ST2 := TRUE;
	BR_ST1 := FALSE;
END_IF;

(* Rung 24: At the beginning of the sequence (no stages active), this rung commands CIP C to start Stage 1 (command 1) and sets the internal state machine to Stage 1. *)
IF CIP_END AND BR_WORK AND NOT BR_ST1 AND NOT BR_ST2 AND NOT BR_ST3 THEN
	CIPCCDL := 1;
	BR_ST1 := TRUE;
	CIP_END := FALSE;
END_IF;

(* Rung 25: When the entire sequence is finished (`BR_END`), this rung sends the final "End" command (7) to CIP C and resets all internal stage flags. *)
IF BR_END THEN
	CIPCCDL := 7;
	BR_ST1 := FALSE;
	BR_ST2 := FALSE;
	BR_ST3 := FALSE;
END_IF;

(* Rung 26: Copies the internal Stage 1 flag (`BR_ST1`) to a global memory address (`M00061`) for external visibility (e.g., HMI). *)
M00061 := BR_ST1;

(* Rung 27: Copies the internal Stage 2 flag (`BR_ST2`) to a global memory address (`M00062`). *)
M00062 := BR_ST2;

(* Rung 28: Copies the internal Stage 3 flag (`BR_ST3`) to a global memory address (`M00063`). *)
M00063 := BR_ST3;